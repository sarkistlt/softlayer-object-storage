'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _request=require('request');var _request2=_interopRequireDefault(_request);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var ObjectStorage=function(){function ObjectStorage(config){_classCallCheck(this,ObjectStorage);this.removeAccess=config.removeAccess||false;this.storage=config.storage;this.endpoint=config.endpoint;this.username=config.username;this.key=config.key;this.container=config.container;this.token={url:this.endpoint,headers:{'X-Auth-Key':this.key,'X-Auth-User':this.username}};}_createClass(ObjectStorage,[{key:'createContainer',value:function createContainer(name){var _this=this;return new Promise(function(resolve,reject){_request2.default.get(_this.token,function(err,res){if(err)reject(err);_request2.default.put({url:JSON.parse(res.body).storage[_this.storage]+'/'+name,headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error,resp){if(error)reject(error);resolve(resp);});});});}},{key:'removeContainer',value:function removeContainer(name){var _this2=this;if(this.removeAccess){return new Promise(function(resolve,reject){_request2.default.get(_this2.token,function(err,res){if(err)reject(err);var containerName=name.split('/')[0]?name.split('/').reverse()[0]:name;_request2.default.delete({url:JSON.parse(res.body).storage[_this2.storage]+'/'+containerName,headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error){if(error)reject({error:error,done:true});resolve({done:true});});});});}else{return Promise.resolve('remove not allowed, set { removeAccess: true } to allow');}}},{key:'listContainers',value:function listContainers(){var _this3=this;return new Promise(function(resolve,reject){_request2.default.get(_this3.token,function(err,res){_request2.default.get({url:''+JSON.parse(res.body).storage[_this3.storage],headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error,_ref){var body=_ref.body;if(error)reject(error);var list=[];body.split('\n').forEach(function(name){if(name){list.push(JSON.parse(res.body).storage[_this3.storage]+'/'+name);}});resolve(list);});});});}},{key:'listFiles',value:function listFiles(){var _this4=this;return new Promise(function(resolve,reject){_request2.default.get(_this4.token,function(err,res){_request2.default.get({url:JSON.parse(res.body).storage[_this4.storage]+'/'+_this4.container,headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error,_ref2){var body=_ref2.body;if(error)reject(error);var list=[];body.split('\n').forEach(function(name){if(name){list.push(JSON.parse(res.body).storage[_this4.storage]+'/'+_this4.container+'/'+name);}});resolve(list);});});});}},{key:'uploadFile',value:function uploadFile(readStream,name){var _this5=this;return new Promise(function(resolve,reject){var filename=name||readStream.path.split('/').reverse()[0];_request2.default.get(_this5.token,function(err,res){if(err)reject(err);var writeStream=_request2.default.put({url:JSON.parse(res.body).storage[_this5.storage]+'/'+_this5.container+'/'+filename,headers:{'X-Auth-Token':res.headers['x-auth-token']}});readStream.pipe(writeStream);readStream.on('exit',resolve);});});}},{key:'removeFile',value:function removeFile(files){var _this6=this;if(this.removeAccess){return new Promise(function(resolve,reject){_request2.default.get(_this6.token,function(err,res){if(err)reject(err);if(Array.isArray(files)){files.forEach(function(file,idx){var filename=file.split('/')[0]?file.split('/').reverse()[0]:file;_request2.default.delete({url:JSON.parse(res.body).storage[_this6.storage]+'/'+_this6.container+'/'+filename,headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error){if(error)reject({error:error,done:true});if(idx===files.length-1)resolve({done:true});});});}else{var filename=files.split('/')[0]?files.split('/').reverse()[0]:files;_request2.default.delete({url:JSON.parse(res.body).storage[_this6.storage]+'/'+_this6.container+'/'+filename,headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error){if(error)reject({error:error,done:true});resolve({done:true});});}});});}else{return Promise.resolve('remove not allowed, set { removeAccess: true } to allow');}}}]);return ObjectStorage;}();exports.default=ObjectStorage;