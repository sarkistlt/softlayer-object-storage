'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var request=require('request');var fs=require('fs');var walk=require('walk');var ObjectStorage=function(){function ObjectStorage(config){_classCallCheck(this,ObjectStorage);this.removeAccess=config.removeAccess||false;this.storage=config.storage;this.endpoint=config.endpoint;this.username=config.username;this.key=config.key;this.container=config.container;this.token={url:this.endpoint,headers:{'X-Auth-Key':this.key,'X-Auth-User':this.username}};}_createClass(ObjectStorage,[{key:'createContainer',value:function createContainer(name){var _this=this;return new Promise(function(resolve,reject){request.get(_this.token,function(err,res){if(err)return reject(err);var token={url:JSON.parse(res.body).storage[_this.storage]+'/'+name,headers:{'X-Auth-Token':res.headers['x-auth-token']}};request.put(token,function(error){if(error)return reject(error);resolve(token.url);});});});}},{key:'removeContainer',value:function removeContainer(name){var _this2=this;if(this.removeAccess){return new Promise(function(resolve,reject){request.get(_this2.token,function(err,res){if(err)return reject(err);var containerName=name.split('/')[0]?name.split('/').reverse()[0]:name;var token={url:JSON.parse(res.body).storage[_this2.storage]+'/'+containerName,headers:{'X-Auth-Token':res.headers['x-auth-token']}};request.delete(token,function(error){if(error)reject({error:error,done:true});resolve({done:true});});});});}return Promise.resolve('remove not allowed, set { removeAccess: true } to allow');}},{key:'listContainers',value:function listContainers(){var _this3=this;return new Promise(function(resolve,reject){request.get(_this3.token,function(err,res){var token={url:''+JSON.parse(res.body).storage[_this3.storage],headers:{'X-Auth-Token':res.headers['x-auth-token']}};request.get(token,function(error,_ref){var body=_ref.body;if(error)return reject(error);var list=[];body.split('\n').forEach(function(name){if(name){list.push(JSON.parse(res.body).storage[_this3.storage]+'/'+name);}});resolve(list);});});});}},{key:'listFiles',value:function listFiles(path){var _this4=this;return new Promise(function(resolve,reject){request.get(_this4.token,function(err,res){var token={url:JSON.parse(res.body).storage[_this4.storage]+'/'+_this4.container,headers:{'X-Auth-Token':res.headers['x-auth-token']}};request.get(token,function(error,_ref2){var body=_ref2.body;if(error)return reject(error);var list=[];body.split('\n').forEach(function(name){if(name){var url=JSON.parse(res.body).storage[_this4.storage]+'/'+_this4.container+'/'+name;if(path){if(~url.indexOf(''+_this4.container+path))list.push(url);}else{list.push(url);}}});resolve(list);});});});}},{key:'uploadFile',value:function uploadFile(file,name,container,cb){var _this5=this;var isFolder=typeof file==='string'&&fs.lstatSync(file).isDirectory();return new Promise(function(resolve,reject){if(isFolder){var rootFolder=file;var walker=walk.walk(rootFolder,{followLinks:false});walker.on('end',function(){return resolve('done');});walker.on('error',reject);return walker.on('file',function(root,stat,next){var filePath=root+'/'+stat.name;var fileName=filePath.split('/').reverse()[0];var containerPath=filePath.replace(rootFolder,'').replace(fileName,'').slice(0,-1);console.log(filePath);_this5.uploadFile(filePath,false,''+_this5.container+containerPath,next);});}var readStream=typeof file==='string'?fs.createReadStream(file):file;var filename=name||readStream.path.split('/').reverse()[0];request.get(_this5.token,function(err,res){if(err)return reject(err);var token={url:JSON.parse(res.body).storage[_this5.storage]+'/'+(container||_this5.container)+'/'+filename,headers:{'X-Auth-Token':res.headers['x-auth-token']}};var writeStream=request.put(token);readStream.pipe(writeStream);readStream.on('error',function(error){if(cb)return cb();reject(error);});readStream.on('close',function(){if(cb)return cb();resolve(token.url);});});});}},{key:'removeFile',value:function removeFile(files){var _this6=this;if(this.removeAccess){return new Promise(function(resolve,reject){request.get(_this6.token,function(err,res){if(err)return reject(err);if(Array.isArray(files)){files.forEach(function(file,idx){var filename=file.split('/')[0]?file.split('/').splice(file.split('/').indexOf(_this6.container)+1).join('/'):file;request.delete({url:JSON.parse(res.body).storage[_this6.storage]+'/'+_this6.container+'/'+filename,headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error){if(error)reject({error:error,done:true});if(idx===files.length-1)resolve({done:true});});});}else{var filename=files.split('/')[0]?files.split('/').splice(files.split('/').indexOf(_this6.container)+1).join('/'):files;request.delete({url:JSON.parse(res.body).storage[_this6.storage]+'/'+_this6.container+'/'+filename,headers:{'X-Auth-Token':res.headers['x-auth-token']}},function(error){if(error)reject({error:error,done:true});resolve({done:true});});}});});}return Promise.resolve('remove not allowed, set { removeAccess: true } to allow');}}]);return ObjectStorage;}();module.exports=ObjectStorage;